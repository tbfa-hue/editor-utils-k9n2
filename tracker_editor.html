<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Tracker Config Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 90%;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .upload-section {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px dashed #555;
            text-align: center;
        }

        .upload-section.dragover {
            border-color: #4CAF50;
            background: #2d3d2d;
        }

        .file-input {
            display: none;
        }

        .upload-btn, .btn {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }

        .upload-btn:hover, .btn:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #2196F3;
        }

        .btn-secondary:hover {
            background: #1976D2;
        }

        .btn-danger {
            background: #f44336;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .tabs {
            display: flex;
            background: #2d2d2d;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            margin-bottom: 0;
        }

        .tab {
            background: #555;
            color: white;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .tab:hover {
            background: #666;
        }

        .tab.active {
            background: #4CAF50;
        }

        .tab-content {
            background: #2d2d2d;
            border-radius: 0 0 8px 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            background: #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        select, input, textarea {
            background: #1a1a1a;
            border: 1px solid #555;
            color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 4px;
        }

        textarea {
            resize: vertical;
            font-family: inherit;
        }

        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .user-card {
            background: #333;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #555;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .user-card:active {
            cursor: grabbing;
        }

        .user-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
        }

        .user-card.drag-over {
            border: 2px solid #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .user-card h3 {
            color: #4CAF50;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-detail {
            margin: 8px 0;
            font-size: 14px;
        }

        .user-detail strong {
            color: #4CAF50;
            min-width: 120px;
            display: inline-block;
        }

        .token-list {
            margin-top: 15px;
        }

        .token-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 8px;
            background: #2a2a2a;
            border-radius: 4px;
            border: 1px solid #555;
        }

        .token-header:hover {
            background: #333;
        }

        .token-toggle {
            font-size: 14px;
            transition: transform 0.2s;
        }

        .token-toggle.expanded {
            transform: rotate(180deg);
        }

        .token-content {
            display: none;
            margin-top: 5px;
        }

        .token-content.expanded {
            display: block;
        }

        .token-item {
            background: #2d2d2d;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #555;
        }

        .token-item h4 {
            color: #2196F3;
            margin-bottom: 5px;
        }

        .keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .keyword {
            background: #4CAF50;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            background-color: #2d2d2d;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #555;
            padding-bottom: 10px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #fff;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #4CAF50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
        }

        .checkbox-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-direction: row;
        }
        
        .checkbox-group input[type="checkbox"] {
            order: -1;
        }

        .modal .form-group label {
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
        }

        .modal .form-group input[type="checkbox"] {
            width: auto !important;
            margin: 0 !important;
        }

        .status {
            background: #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .error {
            color: #f44336;
            background: #3d2d2d;
            border-left: 4px solid #f44336;
        }

        .success {
            color: #4CAF50;
            background: #2d3d2d;
            border-left: 4px solid #4CAF50;
        }

        .json-preview {
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre;
        }

        .discord-usernames {
            background: #2a2a2a;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }

        .discord-usernames h5 {
            color: #2196F3;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .username-tag {
            background: #2196F3;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 5px;
            margin-bottom: 3px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Discord Tracker Config Editor</h1>
            <p>Edit configuration for Discord-based Twitter monitoring</p>
        </div>

        <div class="upload-section" id="uploadSection">
            <p>üìÅ Drag & drop your tracker_config.json file here, or</p>
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Choose File</button>
            <input type="file" id="fileInput" class="file-input" accept=".json" onchange="handleFileSelect(event)">
            
            <div style="margin-top: 20px; text-align: left;">
                <p style="margin-bottom: 10px;">üìã Or paste your JSON content directly:</p>
                <textarea id="jsonPasteArea" placeholder="Paste your tracker_config.json content here..." 
                          style="width: 100%; height: 200px; font-family: 'Courier New', monospace; font-size: 12px;"></textarea>
                <button class="upload-btn" onclick="handleJSONPaste()" style="margin-top: 10px;">Load from Text</button>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="btn" id="loadSavedButton" onclick="loadConfigFromLocalStorage(true)" disabled>Load Saved Config</button>
                <button class="btn btn-secondary" onclick="clearSavedConfig()">Clear Saved Config</button>
            </div>
            <p style="margin-top: 10px; font-size: 12px; color: #999; text-align: center;">
                Saved configurations are stored locally in your browser.
            </p>
        </div>

        <div class="status" id="status" style="display: none;"></div>

        <div id="mainContent" style="display: none;">
            <div class="tabs">
                <button class="tab active" onclick="showTab('users')">üë• Users</button>
                <button class="tab" onclick="showTab('json')">üìÑ JSON</button>
            </div>

            <div id="usersTab" class="tab-content active">
                <div class="controls">
                    <button class="btn" onclick="showAddUserModal()">‚ûï Add User</button>
                    <button class="btn btn-secondary" onclick="downloadJSON()">üì• Download JSON</button>
                </div>
                
                <div id="userList" class="user-list">
                    <!-- Users will be rendered here -->
                </div>
            </div>

            <div id="jsonTab" class="tab-content">
                <div class="controls">
                    <button class="btn btn-secondary" onclick="downloadJSON()">üì• Download JSON</button>
                    <button class="btn" onclick="updateJSONPreview()">üîÑ Load from Data</button>
                    <button class="btn" onclick="applyJSONChanges()">‚úÖ Apply Changes</button>
                    <div class="control-group" style="margin-left: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; color: #e0e0e0;">
                            <input type="checkbox" id="phoneModeToggle" onchange="updateJSONPreview()">
                            <span>üì± Phone Mode</span>
                        </label>
                    </div>
                </div>
                <textarea class="json-preview" id="jsonPreview" style="font-family: 'Courier New', monospace; resize: vertical; min-height: 400px; width: 100%;"></textarea>
            </div>
        </div>

        <!-- User Modal -->
        <div id="userModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="userModalTitle">Add User</h2>
                    <span class="close" onclick="closeUserModal()">&times;</span>
                </div>
                <form id="userForm">
                    <div class="form-group">
                        <label>Twitter Username</label>
                        <input type="text" id="targetUsername" placeholder="e.g., CoinbaseAssets" required>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="activeToggle" checked>
                            <span>Active</span>
                        </label>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
                        <button type="submit" class="btn">Save User</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Token Modal -->
        <div id="tokenModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="tokenModalTitle">Add Token</h2>
                    <span class="close" onclick="closeTokenModal()">&times;</span>
                </div>
                <form id="tokenForm">
                    <input type="hidden" id="tokenUserId">
                    <div class="form-group">
                        <label>Token Name</label>
                        <input type="text" id="tokenName" placeholder="e.g., TROLL, STARTUP" required>
                    </div>
                    <div class="form-group">
                        <label>Chain</label>
                        <select id="tokenChain" onchange="updateDexOptions()">
                            <option value="solana">Solana</option>
                            <option value="bsc">Binance Smart Chain</option>
                            <option value="ethereum">Ethereum</option>
                            <option value="base">Base</option>
                        </select>
                    </div>
                    <div class="form-group" id="dexGroup" style="display: none;">
                        <label>DEX</label>
                        <select id="tokenDex" onchange="updateFeeTierOptions()">
                            <!-- Options populated by updateDexOptions() -->
                        </select>
                        <small style="color: #888; display: block; margin-top: 5px;">
                            Trading path will be auto-generated (e.g., USDT ‚Üí WBNB ‚Üí Token)
                        </small>
                    </div>
                    <div class="form-group" id="feeTierGroup" style="display: none;">
                        <label>V3 Fee Tier (Optional)</label>
                        <select id="tokenFeeTier">
                            <option value="">Default (Auto)</option>
                            <option value="100">0.01% (100)</option>
                            <option value="500">0.05% (500)</option>
                            <option value="3000">0.3% (3000)</option>
                            <option value="10000">1% (10000)</option>
                        </select>
                        <small style="color: #888; display: block; margin-top: 5px;">
                            Only needed if default fee tier fails. Leave as "Default" for automatic selection.
                        </small>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="tokenActive" checked>
                            <span>Active</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Contract Address</label>
                        <input type="text" id="contractAddress" placeholder="Solana contract address" required>
                    </div>
                    <div class="form-group">
                        <label>Buy Amount (USDC)</label>
                        <input type="number" id="buyAmount" value="100" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Max Slippage (bps)</label>
                        <input type="number" id="maxSlippage" value="500" min="0" step="1" required>
                    </div>
                    <div class="form-group">
                        <label>Autosell Minutes (0 = disabled)</label>
                        <input type="number" id="autosellMinutes" value="0" min="0" step="1" placeholder="Minutes after buy to auto-sell" title="Set to 0 to disable autosell, or any positive number of minutes" required>
                    </div>
                    <div class="form-group">
                        <label>Keywords (comma-separated)</label>
                        <textarea id="keywords" placeholder="troll, chaos, bridge, @StreamerSolana" rows="3"></textarea>
                        <small style="color: #888; display: block; margin-top: 5px;">
                            Regular keywords trigger on mentions. @usernames trigger when the tracked account follows that user.
                        </small>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeTokenModal()">Cancel</button>
                        <button type="submit" class="btn">Save Token</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Copy Token Modal -->
        <div id="copyTokenModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="copyTokenModalTitle">Copy Token to Users</h2>
                    <span class="close" onclick="closeCopyTokenModal()">&times;</span>
                </div>
                <div id="copyTokenContent">
                    <div class="form-group">
                        <p>Select users to copy this token to:</p>
                    </div>
                    <div id="userSelectionList">
                        <!-- User checkboxes will be rendered here -->
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeCopyTokenModal()">Cancel</button>
                        <button type="button" class="btn" onclick="executeCopyToken()">Copy Token</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const LOCAL_STORAGE_KEY = 'tracker_config_data_v1';
        let configData = null;
        let editingUser = null;
        let editingToken = null;
        let copyingTokenData = null;
        
        function hasSavedConfig() {
            try {
                return !!localStorage.getItem(LOCAL_STORAGE_KEY);
            } catch (err) {
                console.warn('localStorage unavailable', err);
                return false;
            }
        }

        function updateLoadSavedButtonState() {
            const btn = document.getElementById('loadSavedButton');
            if (!btn) return;
            btn.disabled = !hasSavedConfig();
        }

        function saveConfigToLocalStorage(showMessage = false) {
            if (!configData) return;
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(configData));
                updateLoadSavedButtonState();
                if (showMessage) {
                    showStatus('‚úÖ Configuration saved locally', 'success');
                }
            } catch (err) {
                console.warn('Failed to save config to localStorage', err);
                if (showMessage) {
                    showStatus('‚ö†Ô∏è Could not save configuration locally', 'error');
                }
            }
        }

        function loadConfigFromLocalStorage(showMessage = false) {
            try {
                const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (!stored) {
                    if (showMessage) {
                        showStatus('‚ùå No saved configuration found', 'error');
                    }
                    return false;
                }
                const parsed = JSON.parse(stored);
                if (!parsed.users || typeof parsed.users !== 'object') {
                    throw new Error('Invalid saved configuration');
                }
                configData = parsed;
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                renderUsers();
                updateJSONPreview();
                if (showMessage) {
                    showStatus('‚úÖ Loaded configuration from local storage', 'success');
                }
                updateLoadSavedButtonState();
                return true;
            } catch (err) {
                console.error('Failed to load config from localStorage', err);
                if (showMessage) {
                    showStatus('‚ùå Failed to load saved configuration', 'error');
                }
                return false;
            }
        }

        function clearSavedConfig() {
            try {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                updateLoadSavedButtonState();
                showStatus('‚úÖ Saved configuration cleared', 'success');
            } catch (err) {
                console.warn('Failed to clear local configuration', err);
                showStatus('‚ùå Failed to clear saved configuration', 'error');
            }
        }

        // Initialize drag and drop
        function initDragAndDrop() {
            const uploadSection = document.getElementById('uploadSection');
            
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });
            
            uploadSection.addEventListener('dragleave', () => {
                uploadSection.classList.remove('dragover');
            });
            
            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }
        
        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }
        
        // Handle file processing
        function handleFile(file) {
            if (!file.name.endsWith('.json')) {
                showStatus('Please select a JSON file', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    configData = JSON.parse(e.target.result);
                    
                    if (!configData.users || typeof configData.users !== 'object') {
                        throw new Error('Invalid JSON structure: missing users object');
                    }
                    
                    showStatus(`‚úÖ Loaded configuration with ${Object.keys(configData.users).length} users`, 'success');
                    document.getElementById('uploadSection').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    renderUsers();
                    updateJSONPreview();
                    saveConfigToLocalStorage();

                } catch (error) {
                    showStatus(`‚ùå Error parsing JSON: ${error.message}`, 'error');
                }
            };
            
            reader.readAsText(file);
        }
        
        // Handle JSON paste
        function handleJSONPaste() {
            const jsonText = document.getElementById('jsonPasteArea').value.trim();
            
            if (!jsonText) {
                showStatus('Please paste JSON content in the text area', 'error');
                return;
            }
            
            try {
                configData = JSON.parse(jsonText);
                
                if (!configData.users || typeof configData.users !== 'object') {
                    throw new Error('Invalid JSON structure: missing users object');
                }
                
                showStatus(`‚úÖ Loaded configuration with ${Object.keys(configData.users).length} users`, 'success');
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                renderUsers();
                updateJSONPreview();
                saveConfigToLocalStorage();

            } catch (error) {
                showStatus(`‚ùå Error parsing JSON: ${error.message}`, 'error');
            }
        }
        
        // Show status message
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
            status.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }
        
        // Tab management
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Refresh content if needed
            if (tabName === 'users') {
                renderUsers();
            } else if (tabName === 'json') {
                updateJSONPreview();
            }
        }
        
        // Render users
        function renderUsers() {
            const userList = document.getElementById('userList');
            if (!configData || !configData.users) {
                userList.innerHTML = '<p style="color: #ccc; font-style: italic;">No configuration loaded yet.</p>';
                return;
            }

            const users = configData.users;

            let html = '';
            Object.keys(users).forEach((userId, index) => {
                const user = users[userId];
                const tokens = user.tokens || {};
                
                html += `
                    <div class="user-card" draggable="true" data-user-id="${userId}" data-index="${index}">
                        <h3 style="display: flex; justify-content: space-between; align-items: center;">
                            üë§ ${userId}
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <button class="btn btn-small" onclick="editUser('${userId}')">‚úèÔ∏è</button>
                                <button class="btn btn-small btn-danger" onclick="deleteUser('${userId}')">üóëÔ∏è</button>
                            </div>
                        </h3>
                        <div class="user-detail"><strong>Username:</strong> @${userId}</div>
                        <div class="user-detail"><strong>Active:</strong> ${user.active ? 'Yes' : 'No'}</div>
                        
                        
                        <div class="token-list">
                            <div class="token-header" onclick="toggleTokens('${userId}')">
                                <strong>ü™ô Tokens (${Object.keys(tokens).length})</strong>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <button class="btn btn-small" onclick="event.stopPropagation(); addToken('${userId}')">‚ûï</button>
                                    <span class="token-toggle">‚ñº</span>
                                </div>
                            </div>
                            <div class="token-content" id="tokens-${userId}">
                            ${Object.keys(tokens).map(tokenName => {
                                const token = tokens[tokenName];
                                return `
                                    <div class="token-item" style="position: relative; padding-bottom: 35px;">
                                        <h4>
                                            ${tokenName}
                                            <div style="float: right;">
                                                <button class="btn btn-small" onclick="editToken('${userId}', '${tokenName}')">‚úèÔ∏è</button>
                                                <button class="btn btn-small btn-danger" onclick="deleteToken('${userId}', '${tokenName}')">üóëÔ∏è</button>
                                            </div>
                                        </h4>
                                        <div style="font-size: 12px; color: #ccc;">
                                            <div>üîó ${(token.chain || 'solana').toUpperCase()} | üí∞ ${token.buy_amount} USDC | üìà ${token.max_slippage_bps} bps | ‚è∞ ${token.autosell_minutes || 0}m | ${token.active !== false ? 'üü¢ Active' : 'üî¥ Inactive'}</div>
                                            <div>üìÑ ${token.contract_address?.substring(0, 20)}...</div>
                                        </div>
                                        <div class="keywords" style="margin-bottom: 5px;">
                                            ${(token.keywords || []).map(keyword => 
                                                `<span class="keyword" ${keyword.startsWith('@') ? 'style="background: #2196F3;"' : ''}>${keyword}</span>`
                                            ).join('')}
                                        </div>
                                        <button class="btn btn-small btn-secondary" onclick="copyToken('${userId}', '${tokenName}')" title="Copy to other users" style="position: absolute; bottom: 5px; right: 5px;">üìã</button>
                                    </div>
                                `;
                            }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });

            userList.innerHTML = html;

            // Add drag and drop event listeners to user cards
            document.querySelectorAll('.user-card').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragend', handleDragEnd);
                card.addEventListener('dragenter', handleDragEnter);
                card.addEventListener('dragleave', handleDragLeave);
            });
        }
        
        // User management
        function showAddUserModal() {
            editingUser = null;
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('userForm').reset();
            document.getElementById('userModal').style.display = 'block';
        }
        
        function editUser(userId) {
            editingUser = userId;
            const user = configData.users[userId];
            
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('targetUsername').value = userId;
            document.getElementById('activeToggle').checked = user.active !== false;
            
            document.getElementById('userModal').style.display = 'block';
        }
        
        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }
        
        function deleteUser(userId) {
            if (confirm(`Are you sure you want to delete user "${userId}"?`)) {
                delete configData.users[userId];
                renderUsers();
                updateJSONPreview();
                saveConfigToLocalStorage();
                showStatus(`‚úÖ User "${userId}" deleted`, 'success');
            }
        }
        
        
        // Token management
        function addToken(userId) {
            editingUser = userId;
            editingToken = null;
            document.getElementById('tokenModalTitle').textContent = 'Add Token';
            document.getElementById('tokenUserId').value = userId;
            document.getElementById('tokenForm').reset();
            document.getElementById('tokenChain').value = 'solana';
            updateDexOptions();  // Initialize DEX options
            document.getElementById('tokenModal').style.display = 'block';
        }
        
        function editToken(userId, tokenName) {
            editingUser = userId;
            editingToken = tokenName;
            const token = configData.users[userId].tokens[tokenName];

            document.getElementById('tokenModalTitle').textContent = 'Edit Token';
            document.getElementById('tokenUserId').value = userId;
            document.getElementById('tokenName').value = tokenName;
            document.getElementById('tokenActive').checked = token.active !== false;
            document.getElementById('contractAddress').value = token.contract_address || '';
            document.getElementById('tokenChain').value = (token.chain || 'solana');

            // Update DEX options based on chain
            updateDexOptions();

            // Set DEX if available
            if (token.dex && token.chain !== 'solana') {
                document.getElementById('tokenDex').value = token.dex || '0x';
            }

            // Set fee tier if available
            if (token.fee_tier) {
                document.getElementById('tokenFeeTier').value = token.fee_tier;
            } else {
                document.getElementById('tokenFeeTier').value = '';
            }

            document.getElementById('buyAmount').value = token.buy_amount || 100;
            document.getElementById('maxSlippage').value = token.max_slippage_bps || 500;
            document.getElementById('autosellMinutes').value = (token.autosell_minutes !== null && token.autosell_minutes !== undefined && !isNaN(token.autosell_minutes)) ? token.autosell_minutes : 0;
            document.getElementById('keywords').value = (token.keywords || []).join(', ');

            document.getElementById('tokenModal').style.display = 'block';
        }
        
        // DEX options per chain
        const DEX_OPTIONS = {
            solana: [],  // Solana doesn't need DEX selection (uses Jupiter)
            bsc: [
                { value: 'pancakeswap_v2', label: 'PancakeSwap V2' },
                { value: 'pancakeswap_v3', label: 'PancakeSwap V3' }
            ],
            ethereum: [
                { value: 'uniswap_v2', label: 'Uniswap V2' },
                { value: 'uniswap_v3', label: 'Uniswap V3' }
            ],
            base: [
                { value: 'uniswap_v3', label: 'Uniswap V3' },
                { value: 'aerodrome', label: 'Aerodrome' }
            ]
        };

        function updateDexOptions() {
            const chain = document.getElementById('tokenChain').value;
            const dexGroup = document.getElementById('dexGroup');
            const dexSelect = document.getElementById('tokenDex');

            // Hide DEX selection for Solana
            if (chain === 'solana') {
                dexGroup.style.display = 'none';
                return;
            }

            // Show DEX selection for EVM chains
            dexGroup.style.display = 'block';

            // Populate DEX options
            const options = DEX_OPTIONS[chain] || [];
            dexSelect.innerHTML = options.map(opt =>
                `<option value="${opt.value}">${opt.label}</option>`
            ).join('');

            // Update fee tier options visibility
            updateFeeTierOptions();
        }

        function updateFeeTierOptions() {
            const dex = document.getElementById('tokenDex').value;
            const feeTierGroup = document.getElementById('feeTierGroup');

            // Show fee tier selection only for V3 DEXs
            if (dex && dex.includes('_v3')) {
                feeTierGroup.style.display = 'block';
            } else {
                feeTierGroup.style.display = 'none';
            }
        }

        function closeTokenModal() {
            document.getElementById('tokenModal').style.display = 'none';
        }
        
        function deleteToken(userId, tokenName) {
            if (confirm(`Are you sure you want to delete token "${tokenName}"?`)) {
                delete configData.users[userId].tokens[tokenName];
                renderUsers();
                updateJSONPreview();
                saveConfigToLocalStorage();
                showStatus(`‚úÖ Token "${tokenName}" deleted`, 'success');
            }
        }
        
        // Copy token functionality
        function copyToken(userId, tokenName) {
            const token = configData.users[userId].tokens[tokenName];
            copyingTokenData = {
                sourceUserId: userId,
                tokenName: tokenName,
                tokenData: { ...token }
            };
            
            document.getElementById('copyTokenModalTitle').textContent = `Copy "${tokenName}" to Users`;
            renderUserSelectionList();
            document.getElementById('copyTokenModal').style.display = 'block';
        }
        
        function renderUserSelectionList() {
            const userList = document.getElementById('userSelectionList');
            const users = Object.keys(configData.users);
            const sourceUserId = copyingTokenData.sourceUserId;
            
            let html = '';
            users.forEach(userId => {
                if (userId !== sourceUserId) {
                    const hasToken = configData.users[userId].tokens && configData.users[userId].tokens[copyingTokenData.tokenName];
                    html += `
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="user_${userId}" value="${userId}">
                                <span>${userId} ${hasToken ? '(will overwrite existing)' : ''}</span>
                            </label>
                        </div>
                    `;
                }
            });
            
            if (html === '') {
                html = '<p style="color: #ccc; font-style: italic;">No other users available to copy to.</p>';
            }
            
            userList.innerHTML = html;
        }
        
        function executeCopyToken() {
            if (!copyingTokenData) return;
            
            const selectedUsers = [];
            const checkboxes = document.querySelectorAll('#userSelectionList input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedUsers.push(checkbox.value);
            });
            
            if (selectedUsers.length === 0) {
                showStatus('‚ùå Please select at least one user', 'error');
                return;
            }
            
            // Copy token to selected users
            selectedUsers.forEach(userId => {
                if (!configData.users[userId].tokens) {
                    configData.users[userId].tokens = {};
                }
                configData.users[userId].tokens[copyingTokenData.tokenName] = { ...copyingTokenData.tokenData };
            });
            
            closeCopyTokenModal();
            renderUsers();
            updateJSONPreview();
            saveConfigToLocalStorage();
            showStatus(`‚úÖ Token "${copyingTokenData.tokenName}" copied to ${selectedUsers.length} user(s)`, 'success');
        }
        
        function closeCopyTokenModal() {
            document.getElementById('copyTokenModal').style.display = 'none';
            copyingTokenData = null;
        }
        
        // JSON management
        function updateJSONPreview() {
            if (!configData) return;
            
            const preview = document.getElementById('jsonPreview');
            const phoneModeToggle = document.getElementById('phoneModeToggle');
            const jsonContent = JSON.stringify(configData, null, 2);
            
            if (phoneModeToggle && phoneModeToggle.checked) {
                preview.value = `cd TRACKER\ncat > tracker_config.json << 'EOF'\n${jsonContent}\nEOF`;
            } else {
                preview.value = jsonContent;
            }
        }
        
        function applyJSONChanges() {
            const preview = document.getElementById('jsonPreview');
            let jsonText = preview.value;
            
            // If phone mode is enabled, extract JSON from cat command
            const phoneModeToggle = document.getElementById('phoneModeToggle');
            if (phoneModeToggle && phoneModeToggle.checked) {
                const match = jsonText.match(/cd TRACKER\ncat > tracker_config\.json << 'EOF'\n([\s\S]*?)\nEOF/);
                if (match) {
                    jsonText = match[1];
                } else {
                    showStatus('‚ùå Invalid phone mode format', 'error');
                    return;
                }
            }
            
            try {
                const newConfigData = JSON.parse(jsonText);
                
                // Validate the structure
                if (!newConfigData.users || typeof newConfigData.users !== 'object') {
                    throw new Error('Invalid JSON structure: missing users object');
                }
                
                // Update the config data
                configData = newConfigData;
                
                // Refresh all UI components
                renderUsers();
                updateJSONPreview();
                saveConfigToLocalStorage();
                
                showStatus('‚úÖ JSON changes applied successfully!', 'success');
                
            } catch (error) {
                showStatus(`‚ùå Error parsing JSON: ${error.message}`, 'error');
            }
        }
        
        function downloadJSON() {
            if (!configData) {
                showStatus('‚ùå No data to download', 'error');
                return;
            }
            
            const blob = new Blob([JSON.stringify(configData, null, 2)], { 
                type: 'application/json' 
            });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tracker_config.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('‚úÖ JSON file downloaded!', 'success');
        }
        
        // Form handlers
        document.getElementById('userForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('targetUsername').value;
            const active = document.getElementById('activeToggle').checked;
            
            if (editingUser && editingUser !== username) {
                // Rename user
                configData.users[username] = configData.users[editingUser];
                delete configData.users[editingUser];
            }
            
            if (!configData.users[username]) {
                configData.users[username] = {};
            }
            
            configData.users[username] = {
                ...configData.users[username],
                active: active,
                tokens: configData.users[username].tokens || {}
            };
            
            closeUserModal();
            renderUsers();
            updateJSONPreview();
            saveConfigToLocalStorage();
            showStatus(`‚úÖ User "${username}" saved`, 'success');
        });
        
        document.getElementById('tokenForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const userId = document.getElementById('tokenUserId').value;
            const tokenName = document.getElementById('tokenName').value;
            const tokenActive = document.getElementById('tokenActive').checked;
            const contractAddress = document.getElementById('contractAddress').value.trim();
            const tokenChain = (document.getElementById('tokenChain').value || 'solana').toLowerCase();
            const buyAmount = parseFloat(document.getElementById('buyAmount').value);
            const maxSlippage = parseInt(document.getElementById('maxSlippage').value);
            let autosellMinutes = parseInt(document.getElementById('autosellMinutes').value);
            autosellMinutes = autosellMinutes === null || isNaN(autosellMinutes) ? 0 : autosellMinutes;
            const keywords = document.getElementById('keywords').value
                .split(',')
                .map(k => k.trim().toLowerCase())
                .filter(k => k);

            // Get DEX for EVM chains
            let dex = '';
            let feeTier = null;
            if (tokenChain !== 'solana') {
                dex = document.getElementById('tokenDex').value || '0x';

                // Get fee tier for V3 DEXs (only if not empty/default)
                const feeTierValue = document.getElementById('tokenFeeTier').value;
                if (feeTierValue && feeTierValue !== '') {
                    feeTier = parseInt(feeTierValue);
                }
            }

            if (!configData.users[userId].tokens) {
                configData.users[userId].tokens = {};
            }

            if (editingToken && editingToken !== tokenName) {
                // Rename token
                configData.users[userId].tokens[tokenName] = configData.users[userId].tokens[editingToken];
                delete configData.users[userId].tokens[editingToken];
            }

            // Ensure autosell_minutes is always a valid number, never null
            if (autosellMinutes < 0) {
                autosellMinutes = 0;
            }

            const tokenData = {
                active: tokenActive,
                contract_address: contractAddress,
                chain: tokenChain,
                buy_amount: buyAmount,
                max_slippage_bps: maxSlippage,
                autosell_minutes: autosellMinutes,
                keywords: keywords
            };

            // Add DEX for EVM chains (path auto-generated)
            if (tokenChain !== 'solana') {
                tokenData.dex = dex;

                // Add fee_tier for V3 DEXs if specified
                if (feeTier !== null) {
                    tokenData.fee_tier = feeTier;
                }
            }

            configData.users[userId].tokens[tokenName] = tokenData;
            
            closeTokenModal();
            renderUsers();
            updateJSONPreview();
            saveConfigToLocalStorage();
            showStatus(`‚úÖ Token "${tokenName}" saved`, 'success');
        });
        
        // Token toggle functionality
        function toggleTokens(userId) {
            const tokenContent = document.getElementById(`tokens-${userId}`);
            const tokenToggle = tokenContent.previousElementSibling.querySelector('.token-toggle');
            
            if (tokenContent.classList.contains('expanded')) {
                tokenContent.classList.remove('expanded');
                tokenToggle.classList.remove('expanded');
            } else {
                tokenContent.classList.add('expanded');
                tokenToggle.classList.add('expanded');
            }
        }

        // Drag and drop functionality for user reordering
        let draggedCard = null;

        function handleDragStart(e) {
            draggedCard = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (this !== draggedCard) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (this !== draggedCard) {
                const draggedUserId = draggedCard.dataset.userId;
                const targetUserId = this.dataset.userId;

                reorderUsers(draggedUserId, targetUserId);
            }

            return false;
        }

        function handleDragEnd(e) {
            document.querySelectorAll('.user-card').forEach(card => {
                card.classList.remove('dragging', 'drag-over');
            });
            draggedCard = null;
        }

        function reorderUsers(draggedUserId, targetUserId) {
            const userKeys = Object.keys(configData.users);
            const draggedIndex = userKeys.indexOf(draggedUserId);
            const targetIndex = userKeys.indexOf(targetUserId);

            if (draggedIndex === -1 || targetIndex === -1) return;

            // Create new ordered object
            const newUsers = {};
            const reorderedKeys = [...userKeys];

            // Remove dragged item and insert at target position
            reorderedKeys.splice(draggedIndex, 1);
            reorderedKeys.splice(targetIndex, 0, draggedUserId);

            // Rebuild users object in new order
            reorderedKeys.forEach(userId => {
                newUsers[userId] = configData.users[userId];
            });

            configData.users = newUsers;

            // Re-render and update
            renderUsers();
            updateJSONPreview();
            saveConfigToLocalStorage();
            showStatus(`‚úÖ Moved "${draggedUserId}" user`, 'success');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initDragAndDrop();
            updateLoadSavedButtonState();
            if (loadConfigFromLocalStorage(false)) {
                showStatus('‚úÖ Loaded configuration from local storage', 'success');
            }
        });
    </script>
</body>
</html>
